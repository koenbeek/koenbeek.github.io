<!DOCTYPE html>
<html lang=”en”>

<head>
    <title>Multiple XPaths To List</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/main.css">
</head>

<body>
    <h1>Multiple XPaths To List</h1>
    <div id="xps">
        use predicate [i] to select a record - f.ex. (//tag)[i]/text() -- <a href="docs/xpath.html" target="_blank">XPath cheatsheet</a><br>
    </div>
    <label for="lp">List Pattern :&nbsp;</label><input type="text" id="lp" size=40 value="">
    &nbsp;acc: $1 balance: $$$2 - $n = nth XPath, $$ = $ <br>
</body>
<script type="module">
    import { gE, gV, doSetup, sErr, sOK, addChild, mngAr } from './js/lib.js'
    import { getElByXPath, parseXML } from './js/xml.js'
    const xpt = "XPath ", xps = "40", xpm = 3; let nbrxp = xpm
    function run() {
        nbrxp = mngAr("xp", nbrxp, xpm, xpt, xps)
        let elt = parseXML(gV("intext")), lines = []; const lp = gV("lp");
        if (elt.getElementsByTagName('parsererror').length > 0) { // problem parsing the XML 
            sErr("intext", Error((elt.getElementsByTagName('parsererror')[0].getElementsByTagName('div')[0].innerHTML)))
            return
        }
        sOK(["intext"]);
        for (let l = 1, found = true, v = []; found; l++) { // add lines while predicat matches are found in XML
            found = false
            for (let i = 1; gE("xp" + i) && gV("xp" + i); i++) { // try each XPath match
                let id = "xp" + i, xp = gV(id).replace(/\[i\]/, "[" + l + "]"), pred = gV(id) != xp
                sOK(id)
                try {
                    var els = getElByXPath(xp, elt)
                    v[i] = els[0] || ""
                    if (pred && els.length > 0) found = true;
                } catch (e) { sErr(id, e) }
            }
            let line = lp, xlen = 0, repl, m, re = /\$[0-9$]/gd
            while (m = re.exec(lp)) { // find $$ and $n 
                repl = m[0][1] == "$" ? "$" : v[m[0][1]]
                if (repl == null) continue
                line = line.substring(0, m.index + xlen) + repl + line.substring(m.index + xlen + 2, line.length)
                xlen += repl.length - 2
            }
            if (found) lines.push(line)
        }
        gE("outtext").value = lines.join("\n")
    }
    nbrxp = (await doSetup(run, [10, 100], [10, 100], [{ id: "xp", txt: "XPath ", siz: "40", min: nbrxp }]))[0]; run()
</script>

</html>