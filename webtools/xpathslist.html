<!DOCTYPE html>
<html lang=”en”>

<head>
    <title>Multiple XPaths To List</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/main.css">
</head>

<body>
    <h1>Multiple XPaths To List</h1>
    <div id="xps">
        use predicate [i] to select a record - f.ex. (//tag)[i]/text() -- <a href="docs/xpath.html" target="_blank">XPath cheatsheet</a><br>
    </div>
    <label for="lp">List Pattern :&nbsp;</label><input type="text" id="lp" size=40 value="">
    &nbsp;acc: $1 balance: $$$2 - $n = nth XPath, $$ = $ <br>
</body>
<script type="module">
    import { gE, gV, doSetup, sErr, sOK, addChild } from './js/lib.js';
    import { getElByXPath, parseXML } from './js/xml.js';
    const predre = /\[i\]/;
    for (let i = 1, id = "xp1"; i < 10; i++, id = "xp" + i) {
        addChild("div", { id: "div" + id, innerHTML: '<label for="' + id + '">XPath ' + i + ':&nbsp;</label><input type="text" id="' + id + '" size=40 value=""><br>' }, "xps");
    }
    function run() {
        sOK(["intext"]);
        var elt = parseXML(gV("intext")), lines = [], lp = gV("lp");

        if (elt.getElementsByTagName('parsererror').length > 0) {
            var pe = elt.getElementsByTagName('parsererror');
            sErr("intext", Error((pe[0].getElementsByTagName('div')[0].innerHTML)));
            return
        }
        var first, found = true, v = [];
        for (let l = 1; found; l++) { // add lines while predicat matches are found
            found = false;
            for (let i = 1; gE("xp" + i) && gV("xp" + i); i++) { // try each XPath match
                var id = "xp" + i, xp = gV(id).replace(predre, "[" + l + "]"), pred = gV(id) != xp
                sOK(id)
                try {
                    var els = getElByXPath(xp, elt)
                    v[i] = els[0] || ""
                    if (pred && els.length > 0) found = true;
                } catch (e) { sErr(id, e) }
            }
            var line = lp, xlen = 0, repl, m, re = /\$[0-9$]/gd;
            while (m = re.exec(lp)) { // find $$ and $n 
                repl = m[0][1] == "$" ? "$" : v[Number(m[0][1])]
                if (repl == null) continue
                line = line.substring(0, m.index + xlen) + repl + line.substring(m.index + xlen + 2, line.length)
                xlen += repl.length - 2
            }
            if (first || found) lines.push(line);
        }
        gE("outtext").value = lines.join("\n")
    }
    doSetup(run, [10, 100], [10, 100]);
</script>

</html>